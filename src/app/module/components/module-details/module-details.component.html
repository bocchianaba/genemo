<ng-container *ngIf="module_simple$ | async as module_simple">
  <ng-container>
    <app-banner
      *ngIf="vidanges$ |async as vidanges"
      [description]="true"
      [title]="module_simple.data.stationName"
      [duree_totale]="
        module_simple.data.elapse_total_hours_minutes?.hours +
        ' h ' +
        (module_simple.data.elapse_total_hours_minutes?.minutes
          ? module_simple.data.elapse_total_hours_minutes?.minutes
          : '00') +
        ' m '
      "
      [duree_vidange]="
        module_simple.data.elapse_hours_minutes?.hours +
        ' h ' +
        (module_simple.data.elapse_hours_minutes?.minutes
          ? module_simple.data.elapse_hours_minutes?.minutes
          : '00') +
        ' m '
      "
      [date_vidange]="module_simple.lastInfoVidange.date"
    ></app-banner>
  </ng-container>
  <section>
    <div
      *ngIf="trames$ | async; else no_module"
      class="row d-flex justify-content-between p-4 m-0"
    >
      <ng-container>
        <div class="col-xs-11 col-sm-10 col-md-5 text-center">
          <a routerLink=".." class="mb-4 pb-4 text-center">
            <i class="fa fa-caret-left" aria-hidden="true"></i>
            Liste des modules
          </a>
          <div class="text-center mt-4">
            <div class="row d-flex" *ngIf="trames$ | async as trames">
              <label for="select_form">Sélectionner une trame</label>
              <select
                id="select_form"
                name="select_form"
                class="form-select"
                (change)="update_module_simple($event)"
                aria-label="Default select example"
              >
                <option
                  [value]="mod.id"
                  *ngFor="let mod of trames.data"
                  [id]="mod.id"
                >
                  {{ mod.date | camerounDate : "dddd DD MMMM yyyy à HH:mm" }}
                </option>
              </select>
              <ngb-pagination
                *ngIf="trames.pagination.totalPages"
                class="d-flex justify-content-center my-4"
                (pageChange)="page_change($event)"
                [(page)]="trames.pagination.page"
                [pageSize]="trames.pagination.limit"
                [maxSize]="5"
                [rotate]="true"
                [ellipses]="false"
                [collectionSize]="trames.pagination.totalCount"
              >
              </ngb-pagination>
            </div>
          </div>
          <div class="card border-primary my-4">
            <div class="card-body">
              <h3>
                <span placement="left" [ngbTooltip]="module_simple.data.status.includes('FAULT')?'En défaut':'Sans défaut'" *ngIf="module_simple.data?.status=='NOT_RUNNING/FAULT' ||module_simple.data?.status=='NOT_RUNNING'" class="text-danger">
                  <i class="fa fa-power-off mx-2"></i> En Arrêt
                </span>
                <span placement="left" [ngbTooltip]="module_simple.data.status.includes('FAULT')?'En défaut':'Sans défaut'" *ngIf="module_simple.data?.status=='RUNNING/FAULT' || module_simple.data?.status=='RUNNING'" class="text-success">
                  <i class="fa fa-circle-o-notch fa-spin "></i> En fonction
                </span>
                <span placement="left" [ngbTooltip]="module_simple.data.status.includes('FAULT')?'En défaut':'Sans défaut'" *ngIf="module_simple.data?.status=='STOPPED'" class="text-danger">
                  <i class="fa fa-exclamation-triangle "></i> Arrêt Brusque
                </span>
              </h3>
              <h3 class="card-title text-center fw-bold">Info Récentes</h3>
              <small>
                <i class="fa fa-clock-o mx" aria-hidden="true"></i> Reçu le
                <strong>{{
                  module_simple?.lastInfoTrame?.date
                    | camerounDate : "dddd DD MMMM yyyy à HH:mm"
                }}</strong></small
              >
              <div class="row">
                <div
                  class="col-12 d-flex align-items-center justify-content-center"
                >
                  <div class="row">
                    <app-character-item
                      class="col-6"
                      [title]="'Temperature'"
                      [mesure]="'°C'"
                      [value]="module_simple?.lastInfoTrame?.temp || 0"
                      [ngClass]="{
                        'text-danger':
                          (module_simple.lastInfoTrame.temp ?? 0) > 95
                      }"
                      [icon]="'thermometer-quarter'"
                    ></app-character-item>
                    <app-character-item
                      class="col-6"
                      [mesure]="'%'"
                      [title]="'Fuel Level'"
                      [value]="module_simple?.lastInfoTrame?.fuel || 0"
                      [ngClass]="{
                        'text-danger':
                          (module_simple.lastInfoTrame.fuel ?? 0) < 10
                      }"
                      [icon]="'tint'"
                    ></app-character-item>
                    <app-character-item
                      class="col-6"
                      [mesure]="'VDC'"
                      [title]="'Batterie'"
                      [value]="module_simple?.lastInfoTrame?.bat || 0"
                      [ngClass]="{
                        'text-danger':
                          (module_simple?.lastInfoTrame?.bat ?? 0) < 10
                      }"
                      [icon]="'battery-empty'"
                    ></app-character-item>
                    <app-character-item
                      class="col-6"
                      [mesure]="'Bar'"
                      [title]="'Pression d\'huile'"
                      [value]="module_simple?.lastInfoTrame?.oilPress || 0"
                      [ngClass]="{
                        'text-danger':
                          (module_simple.lastInfoTrame.oilPress ?? 0) < 10
                      }"
                      [icon]="'battery-quarter'"
                    ></app-character-item>
                    <app-character-item
                      class="col-6"
                      [mesure]="'Hz'"
                      [title]="'Fréquence'"
                      [value]="module_simple?.lastInfoTrame?.freq || 0"
                      [ngClass]="{
                        'text-danger':
                          (module_simple?.lastInfoTrame?.freq ?? 0) < 45 ||
                          (module_simple?.lastInfoTrame?.freq ?? 0) > 55
                      }"
                      [icon]="'tint'"
                    ></app-character-item>
                    <!-- <app-character-item
                      class="col-6"
                      [mesure]="'V'"
                      [title]="'Phase 1'"
                      [value]="module_simple?.lastInfoTrame?.ph1 || 0"
                      [ngClass]="{
                        'text-danger':
                          (module_simple.lastInfoTrame.ph1 ?? 0) < 180 ||
                          (module_simple.lastInfoTrame.ph1 ?? 0) > 240
                      }"
                      [icon]="'bolt'"
                    ></app-character-item>
                    <app-character-item
                      class="col-6"
                      [mesure]="'V'"
                      [title]="'Phase 2'"
                      [value]="module_simple?.lastInfoTrame?.ph2 || 0"
                      [ngClass]="{
                        'text-danger':
                          (module_simple.lastInfoTrame.ph2 ?? 0) < 180 ||
                          (module_simple.lastInfoTrame.ph2 ?? 0) > 240
                      }"
                      [icon]="'bolt'"
                    ></app-character-item>
                    <app-character-item
                      class="col-6"
                      [mesure]="'V'"
                      [title]="'Phase 3'"
                      [value]="module_simple?.lastInfoTrame?.ph3 || 0"
                      [ngClass]="{
                        'text-danger':
                          (module_simple.lastInfoTrame.ph3 ?? 0) < 180 ||
                          (module_simple.lastInfoTrame.ph3 ?? 0) > 240
                      }"
                      [icon]="'bolt'"
                    ></app-character-item> -->
                    <div class="col-12">
                      <div class="row px-2 py-2">
                        <div class="card col-12">
                          <div class="card-header align-items-center">
                            Voltage
                            <i class="float-end fa fa-bolt"></i>
                          </div>
                          <div class="card-body">
                            <div class="row d-flex justify-content-between">
                              <div class="col-4"
                                [ngClass]="{
                                  'text-danger':
                                    (module_simple.lastInfoTrame.ph1 ?? 0) < 180 ||
                                    (module_simple.lastInfoTrame.ph1 ?? 0) > 240
                                }">
                                <span style="font-size: 0.65rem">Phase 1</span>
                                <h5
                                  class="card-title"
                                  style="font-weight: bold; font-size: 1.5rem"
                                >
                                  {{ module_simple?.lastInfoTrame?.ph1 || 0 }}
                                  <span class="ctext">V</span>
                                </h5>
                              </div>
                              <div class="col-4"
                                [ngClass]="{
                                  'text-danger':
                                    (module_simple.lastInfoTrame.ph2 ?? 0) < 180 ||
                                    (module_simple.lastInfoTrame.ph2 ?? 0) > 240
                                }">
                                <span style="font-size: 0.65rem">Phase 2</span>
                                <h5
                                  class="card-title"
                                  style="font-weight: bold; font-size: 1.5rem"
                                >
                                  {{ module_simple?.lastInfoTrame?.ph2 || 0 }}
                                  <span class="ctext">V</span>
                                </h5>
                              </div>
                              <div class="col-4"
                                [ngClass]="{
                                  'text-danger':
                                    (module_simple.lastInfoTrame.ph3 ?? 0) < 180 ||
                                    (module_simple.lastInfoTrame.ph3 ?? 0) > 240
                                }">
                                <span style="font-size: 0.65rem">Phase 3</span>
                                <h5
                                  class="card-title"
                                  style="font-weight: bold; font-size: 1.5rem"
                                >
                                  {{ module_simple?.lastInfoTrame?.ph3 || 0 }}
                                  <span class="ctext">V</span>
                                </h5>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xs-11 col-sm-10 col-md-7">
          <div class="row justify-content-center d-flex px-sm-0 px-xs-0 mx-sm-0 mx-xs-0">
            <div class="col-12">
              <div class="row justify-content-center">
                <form class="col-sm-10 col-md-6 justify-content-center mb-4">
                  <div class="row justify-content-center">
                    <div class="col-sm-12 col-lg-10 col-xl-6 my-2">
                      <div class="dp-hidden position-absolute">
                        <div class="input-group">
                          <input
                            name="datepicker"
                            class="form-control"
                            ngbDatepicker
                            #datepicker="ngbDatepicker"
                            [autoClose]="'outside'"
                            (dateSelect)="onDateSelection($event)"
                            [displayMonths]="2"
                            [dayTemplate]="t"
                            outsideDays="hidden"
                            [startDate]="fromDate!"
                            tabindex="-1"
                          />
                          <ng-template #t let-date let-focused="focused">
                            <span
                              class="custom-day"
                              [class.focused]="focused"
                              [class.range]="isRange(date)"
                              [class.faded]="isHovered(date) || isInside(date)"
                              (mouseenter)="hoveredDate = date"
                              (mouseleave)="hoveredDate = null"
                            >
                              {{ date.day }}
                            </span>
                          </ng-template>
                        </div>
                      </div>
                      <div class="input-group">
                        <input
                          #dpFromDate
                          class="form-control"
                          placeholder="yyyy-mm-dd"
                          name="dpFromDate"
                          [value]="formatter.format(fromDate)"
                          (input)="
                            fromDate = validateInput(fromDate, dpFromDate.value)
                          "
                        />
                        <button
                          class="btn btn-outline-secondary"
                          (click)="datepicker.toggle()"
                          type="button"
                        >
                          <i class="fa fa-calendar" aria-hidden="true"></i>
                        </button>
                      </div>
                    </div>
                    <div class="col-sm-12 col-lg-10 col-xl-6 my-2">
                      <div class="input-group">
                        <input
                          #dpToDate
                          class="form-control"
                          placeholder="yyyy-mm-dd"
                          name="dpToDate"
                          [value]="formatter.format(toDate)"
                          (input)="
                            toDate = validateInput(toDate, dpToDate.value)
                          "
                        />
                        <button
                          class="btn btn-outline-secondary bi bi-calendar3"
                          (click)="datepicker.toggle()"
                          type="button"
                        >
                          <i class="fa fa-calendar" aria-hidden="true"></i>
                        </button>
                      </div>
                    </div>
                    <div class="col-12 text-center">
                      <button class="btn btn-primary" (click)="filter_date()">
                        Filtrer les trames par dates
                      </button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
            <div class="col-xs-12 col-sm-12 col-md-12 my-4 px-sm-0 px-xs-0 mx-sm-0 mx-xs-0" style="height: 300px;width:100%">
              <canvas
                baseChart
                class="hide-x-axis chart"
                [data]="fuel_lineChartData"
                [options]="lineChartOptions"
                [type]="lineChartType"
              >
              </canvas>
            </div>
            <div class="col-xs-12 col-sm-12 col-md-12 my-4 px-sm-0 px-xs-0 mx-sm-0 mx-xs-0" style="height: 300px;width:100%">
              <canvas
                baseChart
                class="chart"
                [data]="temperature_lineChartData"
                [options]="lineChartOptions"
                [type]="lineChartType"
              >
              </canvas>
            </div>
            <!-- <div class="col-xs-12 col-sm-12 col-md-12 my-4">
              <canvas
                baseChart
                class="chart"
                [data]="battery_lineChartData"
                [options]="lineChartOptions"
                [type]="lineChartType"
              >
              </canvas>
            </div> -->
            <div class="col-xs-12 col-sm-12 col-md-12 my-4 px-sm-0 px-xs-0 mx-sm-0 mx-xs-0" style="height: 300px;width:100%">
              <canvas
                baseChart
                class="chart"
                [data]="oil_press_lineChartData"
                [options]="lineChartOptions"
                [type]="lineChartType"
              >
              </canvas>
            </div>
            <!-- <div class="col-xs-12 col-sm-12 col-md-12 my-4">
              <canvas
                baseChart
                class="chart"
                [data]="freq_lineChartData"
                [options]="lineChartOptions"
                [type]="lineChartType"
              >
              </canvas>
            </div> -->
            <div class="col-xs-12 col-sm-12 col-md-12 my-4 px-sm-0 px-xs-0 mx-sm-0 mx-xs-0" style="height: 300px;width:100%">
              <canvas
                baseChart
                class="chart"
                [data]="phase_lineChartData"
                [options]="lineChartOptions"
                [type]="lineChartType"
              >
              </canvas>
            </div>
          </div>
          <div class="row">
            <!-- <div class="col-md-6 col-sm-10" *ngIf="trames$ |async as trames">
              <h1 class="text-center card-title text-center fw-bold"> Trames </h1>
              <ngb-accordion #acc="ngbAccordion" activeIds="ngb-panel-0" [closeOthers]="true">
                <ngb-panel *ngFor="let mod of trames.data" [id]="mod.id">
                  <ng-template ngbPanelTitle>
                    {{mod.date | date: 'dd MMMM yyyy à HH:mm'}}
                  </ng-template>
                  <ng-template ngbPanelContent>
                    <div class="row d-flex justify-content-center align-items-center text-center px-4">
                      <div class="col-sm-8 col-md-4 d-flex flex-column py-2 border border-primary">
                        <h6>Fuel</h6>
                        <span>
                          <svg fill="#000000" width="24" height="24" viewBox="0 -29 122.88 122.88" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  style="enable-background:new 0 0 122.88 64.87" xml:space="preserve">
                          <style type="text/css">.st0{fill-rule:evenodd;clip-rule:evenodd;}</style>
                          <g>
                          <path class="st0" d="M6.48,10.34C4.99,10.62,3.2,6.72,4.61,6.08c22.22-12.79,24.46-2.2,46.46,2.86l0.28-0.79 c0.7-1.94,0.67-1.34,2.89-0.72l1.07,0.3c3.66,1.02,2.04,0.73,5-1.16C66.99,2.31,77.1,3.3,83.85,7.65c5.85,3.77,6.3,6.93,7.69,13.05 c1.28,5.61,19.56,22.09,31.34,33.11l-5.56,5.78l-7.73-8.05l-7.92,8.71c-2.14,2.35-3.54,4.85-7.06,4.6c-2.38-0.17-8.58-3.74-11-4.94 l-10.13-5.03c-1.82-1.73-2.68-3.98-2.5-6.81c-2.65,0.34-4.93-0.29-6.87-1.84c-6.98-5.57-3.33-9.32-4.3-15.42 c-0.07-0.42-0.15-0.85-0.26-1.27c-1.58-6.4-5.08-8.43-10.19-10.77c-1.62-0.74-1.45-0.35-0.83-2.03l0.25-0.68 C29.65,11.09,25.52,1.22,6.48,10.34L6.48,10.34z M4.04,10.16c1.01,4.47,4.04,6.7,4.04,8.93c0,2.23-1.01,4.47-4.04,4.47 C1.01,23.56,0,21.33,0,19.09C0,16.86,3.03,14.63,4.04,10.16L4.04,10.16z M77.87,41.66c0.36-1.19,0.21-2.54-0.9-3.61l4.29-3.59 c1.67-1.19,3.54-1.74,5.65-1.48c5.76,0.71,14.38,10.65,18.82,14.73l-8.59,9.72C92.13,50.22,86.47,40.79,77.87,41.66L77.87,41.66z M76.24,46.45c0.49-0.35,1.07-0.51,1.75-0.48l4.15,7.72C80.1,53.03,71.85,49.62,76.24,46.45L76.24,46.45z M81.53,45.17 c2.98,1.46,7.29,6.6,11.54,12.06c0.79,0.64-0.1,2.51-2.09,0.97l-2.61-1.39C83.54,54.08,82.99,51.5,81.53,45.17L81.53,45.17z"/>
                          </g>
                          </svg>
                          {{mod.fuel||0}} %
                        </span>
                      </div>
                      <div class="col-sm-8 col-md-4 d-flex flex-column py-2 border border-primary">
                        <h6>Température</h6>
                        <span>
                          <i class="fa fa-thermometer-quarter mx-2"></i>
                          {{mod.temp||0}} °C
                        </span>
                      </div>
                      <div class="col-sm-8 col-md-4 d-flex flex-column py-2 border border-primary">
                        <h6>Battérie</h6>
                        <span>
                          <i class="fa fa-battery-quarter mx-2"></i>
                          {{mod.bat||0}} VDC
                        </span>
                      </div>
                      <div class="col-sm-8 col-md-4 d-flex flex-column py-2 border border-primary">
                        <h6>Phase 1</h6>
                        <span>
                          <i class="fa fa-bolt mx-2" aria-hidden="true"></i>
                          {{mod.ph1??0}} V
                        </span>
                      </div>
                      <div class="col-sm-8 col-md-4 d-flex flex-column py-2 border border-primary">
                        <h6>Phase 2</h6>
                        <span>
                          <i class="fa fa-bolt mx-2" aria-hidden="true"></i>
                          {{mod.ph2??0}} V
                        </span>
                      </div>
                      <div class="col-sm-8 col-md-4 d-flex flex-column py-2 border border-primary">
                        <h6>Phase 3</h6>
                        <span>
                          <i class="fa fa-bolt mx-2" aria-hidden="true"></i>
                          {{mod.ph3??0}} V
                        </span>
                      </div>
                      <div class="col-sm-8 col-md-4 d-flex flex-column py-2 border border-primary">
                        <h6>Pression d'huile</h6>
                        <span>
                          <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M14,19V17.73a8,8,0,1,0-4,0V19H2v3H22V19ZM6.12,11.17A5.9,5.9,0,0,1,6.46,7.7a6,6,0,1,1,7.84,7.84,5.9,5.9,0,0,1-3.47.34,6,6,0,0,1-4.71-4.71ZM11,14.05A1.41,1.41,0,0,1,10.5,13c.17-1.9,1.5-7.5,1.5-7.5s1.33,5.6,1.5,7.5a1.39,1.39,0,0,1-.45,1.05h0l0,0A1.45,1.45,0,0,1,11,14.05ZM7,10H8v1H7Zm9,0h1v1H16Zm0-2H15V7h1ZM8,7H9V8H8Zm3-1H10V5h1Zm3,0H13V5h1Z"/><rect width="24" height="24" fill="none"/></svg>
                          {{mod.oilPress??0}} Bar
                        </span>
                      </div>
                      <div class="col-sm-8 col-md-4 d-flex flex-column py-2 border border-primary">
                        <h6>Fréquence</h6>
                        <span>
                          <svg width="24" height="24" viewBox="0 0 24 24" id="frequency-2" data-name="Flat Line" xmlns="http://www.w3.org/2000/svg" class="icon flat-line"><polyline id="primary" points="21 12 17 12 15 16 11 8 8 15 6 12 3 12" style="fill: none; stroke: #000000; stroke-linecap: round; stroke-linejoin: round; stroke-width: 2;"></polyline></svg>
                          {{mod.freq??0}} Hz
                        </span>
                      </div>
                    </div>
                  </ng-template>
                </ngb-panel>
              </ngb-accordion>
              <ngb-pagination *ngIf="trames.pagination.totalPages" class="d-flex justify-content-center my-4" (pageChange)="page_change($event)"
                [(page)]="trames.pagination.page"
                [pageSize]="trames.pagination.limit"
                [collectionSize]="trames.pagination.totalCount">
              </ngb-pagination>
            </div>
            <div class="col-md-6 col-sm-10" *ngIf="vidanges$ |async as vidanges">
              <h1 class="text-center card-title text-center fw-bold">Vidanges</h1>
              <ngb-accordion #acc="ngbAccordion" activeIds="ngb-panel-0" [closeOthers]="true">
                <ngb-panel *ngFor="let vidange of vidanges.data" [id]="vidange.id">
                  <ng-template ngbPanelTitle>
                    {{vidange.date | date: 'dd MMMM yyyy à HH:mm'}} - {{vidange.createdAt| date: 'dd MMMM yyyy à HH:mm'}}</ng-template>
                  <ng-template ngbPanelContent>
                    <div class="row d-flex justify-content-center align-items-center text-center px-4">
                      <div class="col-12 my-2">
                        <div class="alert alert-info row d-flex p-2">
                          <div class="col-2">
                            <i class="fa fa-info-circle" aria-hidden="true"></i>
                          </div>
                          <div class="col-9">
                            {{vidange.remarque}}
                          </div>
                        </div>
                      </div>
                    </div>
                  </ng-template>
                </ngb-panel>
              </ngb-accordion>
              <ngb-pagination *ngIf="vidanges.pagination.totalPages" class="d-flex justify-content-center my-4" (pageChange)="page_change($event)"
                [(page)]="vidanges.pagination.page"
                [pageSize]="vidanges.pagination.limit"
                [collectionSize]="vidanges.pagination.totalCount">
              </ngb-pagination>
            </div> -->
          </div>
        </div>
      </ng-container>
    </div>
    <ng-template #no_module>
      <div
        *ngIf="!loading"
        class="row d-flex justify-content-center align-items-center"
      >
        <div class="col-sm-10 col-md-6 col-lg-4">
          <div class="row justify-content-center">
            <img src="assets/error.png" alt="error image" />
          </div>
        </div>
        <h1 class="text-center mt-4 pt-4 text-danger">
          <i class="fa fa-exclamation-triangle" aria-hidden="true"></i>
          {{ err_message }}
        </h1>
        <p class="text-center">Module introuvable.</p>
        <a routerLink="/modules" class="mb-4 pb-4 text-center">
          <i class="fa fa-caret-left" aria-hidden="true"></i>
          Aller vers la liste de modules
        </a>
      </div>
    </ng-template>
  </section>
</ng-container>
