<ng-container *ngIf="module_simple$| async as module_simple">
  <app-banner [title]="module_simple.data.stationName"
    [description]="'A déjà fonctionner '+module_simple.data.elapse_total.years+' ans '+module_simple.data.elapse_total.months+' mois '+module_simple.data.elapse_total.days+' jours '+module_simple.data.elapse_total.hours+' h '+module_simple.data.elapse_total.minutes+' min , depuis la création <br> Fonctionne '+module_simple.data.elapse.years+' ans '+module_simple.data.elapse.months+' mois '+module_simple.data.elapse.days+' jours '+module_simple.data.elapse.hours+' h '+module_simple.data.elapse.minutes+' min , depuis la dernière vidange'"></app-banner>
  <section>
    <div *ngIf="trames$ |async ; else no_module" class="row d-flex justify-content-center p-4 m-0">
      <ng-container>
        <div class="col-xs-11 col-sm-10 col-md-2 text-center">
          <a routerLink="/modules" class="mb-4 pb-4 text-center">
            <i class="fa fa-caret-left" aria-hidden="true"></i>
            Liste des modules
          </a>
          <div class="text-center mt-4">
            <form class="row row-cols-sm-auto justify-content-center">
              <div class="col-12 my-2">
                <div class="dp-hidden position-absolute">
                  <div class="input-group">
                    <input
                      name="datepicker"
                      class="form-control"
                      ngbDatepicker
                      #datepicker="ngbDatepicker"
                      [autoClose]="'outside'"
                      (dateSelect)="onDateSelection($event)"
                      [displayMonths]="2"
                      [dayTemplate]="t"
                      outsideDays="hidden"
                      [startDate]="fromDate!"
                      tabindex="-1"
                    />
                    <ng-template #t let-date let-focused="focused">
                      <span
                        class="custom-day"
                        [class.focused]="focused"
                        [class.range]="isRange(date)"
                        [class.faded]="isHovered(date) || isInside(date)"
                        (mouseenter)="hoveredDate = date"
                        (mouseleave)="hoveredDate = null"
                      >
                        {{ date.day }}
                      </span>
                    </ng-template>
                  </div>
                </div>
                <div class="input-group">
                  <input
                    #dpFromDate
                    class="form-control"
                    placeholder="yyyy-mm-dd"
                    name="dpFromDate"
                    [value]="formatter.format(fromDate)"
                    (input)="fromDate = validateInput(fromDate, dpFromDate.value)"
                  />
                  <button class="btn btn-outline-secondary" (click)="datepicker.toggle()" type="button">
                    <i class="fa fa-calendar" aria-hidden="true"></i>
                  </button>
                </div>
              </div>
              <div class="col-12 my-2">
                <div class="input-group">
                  <input
                    #dpToDate
                    class="form-control"
                    placeholder="yyyy-mm-dd"
                    name="dpToDate"
                    [value]="formatter.format(toDate)"
                    (input)="toDate = validateInput(toDate, dpToDate.value)"
                  />
                  <button class="btn btn-outline-secondary bi bi-calendar3" (click)="datepicker.toggle()" type="button">
                    <i class="fa fa-calendar" aria-hidden="true"></i>
                  </button>
                </div>
              </div>
            </form>
            <button class="btn btn-primary" (click)="filter_date()"> Filtrer par dates</button>
          </div>
          <div class="card border-primary my-4">
            <div class="card-body">
              <h3 class="card-title text-center fw-bold">Dernières infos</h3>
              <div class="row">
                <div class="col-12 d-flex flex-column align-items-center justify-content-center">
                  <app-character-item class="w-75" [title]="'Temperature'" [mesure]="'°C'" [value]="module_simple.data.lastInfoTrame.temp||0"
                    [icon]="'thermometer-quarter'"></app-character-item>
                  <app-character-item class="w-75" [mesure]="'%'" [title]="'Fuel'" [value]="module_simple.data.lastInfoTrame.fuel||0"
                    [icon]="'tint'"></app-character-item>
                  <app-character-item class="w-75" [mesure]="'%'" [title]="'Batterie'" [value]="module_simple.data.lastInfoTrame.bat||0"
                   [icon]="'battery-quarter'"></app-character-item>
                   <app-character-item class="w-75" [mesure]="'Bar'" [title]="'Pression d\'huile'" [value]="module_simple.data.lastInfoTrame.oilPress||0"
                    [icon]="'battery-quarter'"></app-character-item>
                  <app-character-item class="w-75" [mesure]="'V'" [title]="'Phase 1'" [value]="module_simple.data.lastInfoTrame.ph1||0"
                   [icon]="'bolt'"></app-character-item>
                  <app-character-item class="w-75" [mesure]="'V'" [title]="'Phase 2'" [value]="module_simple.data.lastInfoTrame.ph2||0"
                   [icon]="'bolt'"></app-character-item>
                  <app-character-item class="w-75" [mesure]="'V'" [title]="'Phase 3'" [value]="module_simple.data.lastInfoTrame.ph3||0"
                   [icon]="'bolt'"></app-character-item>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xs-11 col-sm-10 col-md-10">
          <div class="row">
            <div class="col-xs-11 col-sm-10 col-md-4">
              <canvas baseChart class="chart" [data]="fuel_lineChartData" [options]="lineChartOptions" [type]="lineChartType">
              </canvas>
            </div>
            <div class="col-xs-11 col-sm-10 col-md-4">
              <canvas baseChart class="chart" [data]="temperature_lineChartData" [options]="lineChartOptions" [type]="lineChartType">
              </canvas>
            </div>
            <div class="col-xs-11 col-sm-10 col-md-4">
              <canvas baseChart class="chart" [data]="battery_lineChartData" [options]="lineChartOptions" [type]="lineChartType">
              </canvas>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 col-sm-10" *ngIf="trames$ |async as trames">
              <h1 class="text-center card-title text-center fw-bold"> Trames </h1>
              <ngb-accordion #acc="ngbAccordion" activeIds="ngb-panel-0" [closeOthers]="true">
                <ngb-panel *ngFor="let mod of trames.data" [id]="mod.id">
                  <ng-template ngbPanelTitle>
                    {{mod.date | date: 'dd MMMM yyyy à HH:mm'}} - {{mod.createdAt| date: 'dd MMMM yyyy à HH:mm'}}</ng-template>
                  <ng-template ngbPanelContent>
                    <div class="row d-flex justify-content-center align-items-center text-center px-4">
                      <div class="col-sm-8 col-md-4 d-flex flex-column py-2 border border-primary">
                        <h6>Fuel</h6>
                        <span>
                          <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M14,19V17.73a8,8,0,1,0-4,0V19H2v3H22V19ZM6.12,11.17A5.9,5.9,0,0,1,6.46,7.7a6,6,0,1,1,7.84,7.84,5.9,5.9,0,0,1-3.47.34,6,6,0,0,1-4.71-4.71ZM11,14.05A1.41,1.41,0,0,1,10.5,13c.17-1.9,1.5-7.5,1.5-7.5s1.33,5.6,1.5,7.5a1.39,1.39,0,0,1-.45,1.05h0l0,0A1.45,1.45,0,0,1,11,14.05ZM7,10H8v1H7Zm9,0h1v1H16Zm0-2H15V7h1ZM8,7H9V8H8Zm3-1H10V5h1Zm3,0H13V5h1Z"/><rect width="24" height="24" fill="none"/></svg>
                          {{mod.fuel||0}} %
                        </span>
                      </div>
                      <div class="col-sm-8 col-md-4 d-flex flex-column py-2 border border-primary">
                        <h6>Température</h6>
                        <span>
                          <i class="fa fa-thermometer-quarter mx-2"></i>
                          {{mod.temp||0}} °C
                        </span>
                      </div>
                      <div class="col-sm-8 col-md-4 d-flex flex-column py-2 border border-primary">
                        <h6>Battérie</h6>
                        <span>
                          <i class="fa fa-battery-quarter mx-2"></i>
                          {{mod.bat||0}} VDC
                        </span>
                      </div>
                      <div class="col-sm-8 col-md-4 d-flex flex-column py-2 border border-primary">
                        <h6>Phase 1</h6>
                        <span>
                          <i class="fa fa-bolt mx-2" aria-hidden="true"></i>
                          {{mod.ph1??0}} VAC
                        </span>
                      </div>
                      <div class="col-sm-8 col-md-4 d-flex flex-column py-2 border border-primary">
                        <h6>Phase 2</h6>
                        <span>
                          <i class="fa fa-bolt mx-2" aria-hidden="true"></i>
                          {{mod.ph2??0}} VAC
                        </span>
                      </div>
                      <div class="col-sm-8 col-md-4 d-flex flex-column py-2 border border-primary">
                        <h6>Phase 3</h6>
                        <span>
                          <i class="fa fa-bolt mx-2" aria-hidden="true"></i>
                          {{mod.ph3??0}} VAC
                        </span>
                      </div>
                      <div class="col-sm-8 col-md-4 d-flex flex-column py-2 border border-primary">
                        <h6>Pression d'huile</h6>
                        <span>
                          <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M14,19V17.73a8,8,0,1,0-4,0V19H2v3H22V19ZM6.12,11.17A5.9,5.9,0,0,1,6.46,7.7a6,6,0,1,1,7.84,7.84,5.9,5.9,0,0,1-3.47.34,6,6,0,0,1-4.71-4.71ZM11,14.05A1.41,1.41,0,0,1,10.5,13c.17-1.9,1.5-7.5,1.5-7.5s1.33,5.6,1.5,7.5a1.39,1.39,0,0,1-.45,1.05h0l0,0A1.45,1.45,0,0,1,11,14.05ZM7,10H8v1H7Zm9,0h1v1H16Zm0-2H15V7h1ZM8,7H9V8H8Zm3-1H10V5h1Zm3,0H13V5h1Z"/><rect width="24" height="24" fill="none"/></svg>
                          {{mod.oilPress??0}} Bar
                        </span>
                      </div>
                      <!-- <table class="table table-hover table-bordered table-responsive mx-4">
                          <thead class="thead-default table-dark">
                            <tr class=" align-middle">
                              <th>Heure</th>
                              <th>Temperature</th>
                              <th>Fuel</th>
                              <th>frequence</th>
                              <th>Pression d'huile</th>
                              <th>Phase 1</th>
                              <th>Phase 2</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr  *ngFor="let modul of mod." class=" align-middle">
                              <td scope="row">{{modul.date | date: 'HH:mm:ss'}}</td>
                              <td>{{modul.temperature}} °C</td>
                              <td>{{modul.fuel}} L</td>
                              <td>{{modul.frequence}} Mhz</td>
                              <td>{{modul.pression_huile}} Bar</td>
                              <td>{{modul.phase1}}</td>
                              <td>{{modul.phase2}}</td>
                            </tr>
                          </tbody>
                        </table> -->
                    </div>
                  </ng-template>
                </ngb-panel>
              </ngb-accordion>
              <ngb-pagination *ngIf="trames.pagination.totalPages" class="d-flex justify-content-center my-4" (pageChange)="page_change($event)"
                [(page)]="trames.pagination.page"
                [pageSize]="trames.pagination.limit"
                [collectionSize]="trames.pagination.totalCount">
              </ngb-pagination>
            </div>
            <div class="col-md-6 col-sm-10" *ngIf="vidanges$ |async as vidanges">
              <h1 class="text-center card-title text-center fw-bold">Vidanges</h1>
              <ngb-accordion #acc="ngbAccordion" activeIds="ngb-panel-0" [closeOthers]="true">
                <ngb-panel *ngFor="let vidange of vidanges.data" [id]="vidange.id">
                  <ng-template ngbPanelTitle>
                    {{vidange.date | date: 'dd MMMM yyyy à HH:mm'}} - {{vidange.createdAt| date: 'dd MMMM yyyy à HH:mm'}}</ng-template>
                  <ng-template ngbPanelContent>
                    <div class="row d-flex justify-content-center align-items-center text-center px-4">
                      <div class="col-12 my-2">
                        <div class="alert alert-info row d-flex p-2">
                          <div class="col-2">
                            <i class="fa fa-info-circle" aria-hidden="true"></i>
                          </div>
                          <div class="col-9">
                            {{vidange.remarque}}
                          </div>
                        </div>
                      </div>
                      <!-- <div class="col-12 mb-2">
                        <small>
                          <strong>
                            A fonctionner pendant {{vidange.days}} JOURS à la vidange sa phase était de {{vidange.ph3}}
                          </strong>
                        </small>
                      </div> -->
                      <!-- <table class="table table-hover table-bordered table-responsive mx-4">
                          <thead class="thead-default table-dark">
                            <tr class=" align-middle">
                              <th>Heure</th>
                              <th>Temperature</th>
                              <th>Fuel</th>
                              <th>frequence</th>
                              <th>Pression d'huile</th>
                              <th>Phase 1</th>
                              <th>Phase 2</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr  *ngFor="let modul of mod." class=" align-middle">
                              <td scope="row">{{modul.date | date: 'HH:mm:ss'}}</td>
                              <td>{{modul.temperature}} °C</td>
                              <td>{{modul.fuel}} L</td>
                              <td>{{modul.frequence}} Mhz</td>
                              <td>{{modul.pression_huile}} Bar</td>
                              <td>{{modul.phase1}}</td>
                              <td>{{modul.phase2}}</td>
                            </tr>
                          </tbody>
                        </table> -->
                    </div>
                  </ng-template>
                </ngb-panel>
              </ngb-accordion>
              <ngb-pagination *ngIf="vidanges.pagination.totalPages" class="d-flex justify-content-center my-4" (pageChange)="page_change($event)"
                [(page)]="vidanges.pagination.page"
                [pageSize]="vidanges.pagination.limit"
                [collectionSize]="vidanges.pagination.totalCount">
              </ngb-pagination>
            </div>
          </div>
        </div>
      </ng-container>
    </div>
    <ng-template #no_module>
      <div class="row d-flex justify-content-center align-items-center">
        <div class="col-sm-10 col-md-6 col-lg-4">
          <div class="row justify-content-center">
            <img src="assets/error.png" alt="error image">
          </div>
        </div>
        <h1 class="text-center mt-4 pt-4 text-danger">
          <i class="fa fa-exclamation-triangle" aria-hidden="true"></i>
          {{err_message}}
        </h1>
        <p class="text-center">Module introuvable.</p>
        <a routerLink="/modules" class="mb-4 pb-4 text-center">
          <i class="fa fa-caret-left" aria-hidden="true"></i>
          Aller vers la liste de modules
        </a>
      </div>
    </ng-template>
  </section>
</ng-container>
